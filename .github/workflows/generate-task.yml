name: Generate New Task from Template

on:
  issues:
    types: [opened, reopened]

jobs:
  generate-task:
    # Temporarily remove label condition to debug
    # if: contains(github.event.issue.labels.*.name, 'task-generation')
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Check if this is a task generation request
        id: check
        uses: actions/github-script@v7
        with:
          script: |
            const title = context.payload.issue.title;
            console.log('Issue title:', title);
            
            const isTaskRequest = title.startsWith('[NEW_TASK]');
            console.log('Starts with [NEW_TASK]:', isTaskRequest);
            
            if (!isTaskRequest) {
              console.log('⏭️ Skipping: Issue title does not start with [NEW_TASK]');
              core.setOutput('skip', 'true');
            } else {
              console.log('✅ Proceeding: This is a task generation request');
              core.setOutput('skip', 'false');
            }
            
            return {
              title: title,
              isTaskRequest: isTaskRequest,
              skip: !isTaskRequest
            };

      - name: Test action trigger
        if: steps.check.outputs.skip != 'true'
        run: |
          echo "✅ GitHub Action triggered successfully!"
          echo "Issue title: ${{ github.event.issue.title }}"
          echo "Issue number: ${{ github.event.issue.number }}"
          echo "Issue labels: ${{ join(github.event.issue.labels.*.name, ', ') }}"

      - name: Comment on issue with debug info
        if: steps.check.outputs.skip != 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const comment = `
            ## � GitHub Action Debug Information
            
            ✅ **Action Successfully Triggered!**
            
            **Issue Details:**
            - **Title**: ${{ github.event.issue.title }}
            - **Number**: #${{ github.event.issue.number }}
            - **Labels**: ${{ join(github.event.issue.labels.*.name, ', ') }}
            - **Author**: @${{ github.event.issue.user.login }}
            
            **Next Steps:**
            This is a debug version of the action. The full task generation functionality will be implemented next.
            
            **Issue Body Preview (first 500 chars):**
            \`\`\`
            ${context.payload.issue.body.substring(0, 500)}
            \`\`\`
            
            ---
            *If you see this comment, the GitHub Action is working correctly!*
            `;
            
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Add completion label
        if: steps.check.outputs.skip != 'true'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.addLabels({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: ['action-tested']
            });

      - name: Comment on skipped issues
        if: steps.check.outputs.skip == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const comment = `
            ## ⏭️ GitHub Action Skipped
            
            This issue was skipped because the title doesn't start with \`[NEW_TASK]\`.
            
            **Issue Details:**
            - **Title**: ${{ github.event.issue.title }}
            
            **To trigger task generation:**
            1. Edit the issue title to start with \`[NEW_TASK]\`
            2. Or create a new issue with title starting with \`[NEW_TASK]\`
            3. Use the issue form template to provide all required information
            
            **Example title:** \`[NEW_TASK] Business Process Optimization Task\`
            
            ---
            *This comment confirms the GitHub Action is working but skipped this issue.*
            `;
            
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });